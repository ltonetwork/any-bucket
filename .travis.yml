language: node_js
node_js: 16

branches:
  only:
    - main
    - /^v\d+\.\d+\.\d+$/

stages:
  - name: test
    if: tag IS blank
  - name: deploy

before_install:
  - git config --local user.name "LTO Network"
  - git config --local user.email "info@ltonetwork.com"
install:
  - npm install

jobs:
  fast_finish: true
  include:
    - name: "Test"
      stage: test
      script:
        - npm test
    - name: "Publish GitHub release"
      stage: deploy
      if: branch = main AND type = push
      before_script:
        - CURRENT_VERSION=$(git describe --tags --abbrev=0)
        - |
          if (git log $CURRENT_VERSION..HEAD | grep -q -i "\[bump:major\]"); then
            NEXT_VERSION=$(awk -F. -v OFS=. '{$1++;$2=0;$3=0;print}' <<< "$CURRENT_VERSION")
          elif (git log $CURRENT_VERSION..HEAD | grep -q -i "\[bump:minor\]"); then
            NEXT_VERSION=$(awk -F. -v OFS=. '{$2++;$3=0;print}' <<< "$CURRENT_VERSION")
          else
            NEXT_VERSION=$(awk -F. -v OFS=. '{$3++;print}' <<< "$CURRENT_VERSION")
          fi
      script:
        - git tag "$NEXT_VERSION"
      before_deploy:
        - npm run build
      deploy:
        provider: releases
        api_key:
          secure: "AAxY3ThEjky209JXyPuWgyi2KkQGJNndAm7/8B2clREEs0qVZiOS3QUCLa0MhP1HBq+QdP2L2Z3xevUv/NzYvX4xgZQiIHnlEZcWMOALS2g1mZwWPZLKWQ50KEETD56qbglcA+wxLOu3h13IYlXniY++i1+8NzIR5s5+U5qor0ehEjUXKYoGqrfz36qdR2u0zEtss+haNli70PqWcrF1QuoIQgikR0il3SwvcedtlBj8Ss2p3u6O/6ba3MnNnE8nxih6o5A63geY5Uio1DCXYnuK7EmuXc6pYkqOhBOHc1szMDUi/d5kX08/dGoZ/HPonGSbzzCkdx6akCToRVSmb9sgUkwY0J1QlEIlHqhu3M+03BgdnzbOdbp9rqI+fIaCCgivbiUdRhCstL5jPn0ltMmoXCCtRPkSkeIBjbOfdr4uuRyDT/2PFSDIw1VglKeRF3SIuzVzDz+gq/ZWwZX74MyPkOuEXcTBSeSu3yCAWvCWYUhTzo1d7bjOsIVvxOkLsf5xgwi9LNIu5SzdhnJUd+ruqhzXfooo+XVs82/1PZwDpNIu0GNoqkPnsvWNfU1xt6/UH7n5tj/TSjrA9Wf2yLPfEX1b7OO8LrtcCt5ncwvuumYwEq10zJwYBfjCBJDTNyiWY+VmjMlFgiNt7mmuPKFHaqBp/QeS7RYw0KKLrt4="
        cleanup: false
        skip_cleanup: true
        on:
          all_branches: true
    - name: "Publish to NPM"
      stage: deploy
      if: tag IS present
      before_install:
        - npm version $TRAVIS_TAG --no-git-tag-version
      script:
        - npx tsc
      deploy:
        provider: npm
        email: arnold@jasny.net
        api_key:
          secure: "DX1lqgQCnfhPE829g2wLIqAseMLLwzJ+N53GaETauIDfpCzff9MLNZhfsdkNLwZU29duVHbqzTaX/3vSIde56Qe75OTQUPvvcMjrAsorH3lTHQQZPQ4nu60sZMflP1XFEt9DabGfyCa8K1N0H17OFurcu831l5yvHrXUgjy4XPLEqOzFbJDc9UwMVtPWN0QwP2hBYkX/PzbXV0sYj/G4SjRKo4GBDJU8IgQ507vQYWMdBTwsQYByt3cD8jcCIV04WKtnqLozrhzhYJvLQiFNzJodBNNkkgooMQT4DaRVaXug4qXjF+gVO82fa36Vwc89GfJiLvBr1M5Fe8FfBgbqW/+4ZwZccRzfE6pf4QdLVdp1ZGkDu3RrnodjQnAJjldAlIi2xdrTzHy+3rDtym7PCs2QY6zA6fGokx/3Wxch4HfwgW051PQEZ30xfEDBmQDdPhCO11OW0qzGSuwzZb72lgRYzHqooeeqE4ohAmJE0qi3dmqlyBMarttLY/JXfTpZUKCx/pRwWvYI8qIyO5wJH8QtrDSvi/FWb+Ed/xg6Eg0ewEv5c/zKEs1sGcWfyaVuIy0WpRRzZPvUJOchyciu23s9IZRHO9z9anE2hW0c7NiCHkfdc7DjZ6DVR2BEVFc4tCU3L2FsGpG0S0UBSv5gVCzleWxQC49xZwlqjPfXtnY="
        on:
          tags: true
        cleanup: false
        skip_cleanup: true
